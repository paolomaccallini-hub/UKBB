# UKBB
This software performs GWAS analysis on summary statistics generated by Neale's Lab from the UK Biobank database. In particular, it defines risk loci and performs fine-mapping. The resulting variants are mapped to genes using both positional criteria and regulatory attributes.
# UKBB GWAS Pipeline

All the settings, including the traits to study, are in the YML file. The uploaded file is set for analysis of the following two phenotypes: 20002_1482 (self-reported Chronic Fatigue Syndrome) and ICD-10: R53 (Chronic Fatigue). But the phenotypes of interest can be any of the list: https://broad-ukb-sumstats-us-east-1.s3.amazonaws.com/round2/annotations/phenotypes.both_sexes.v2.tsv.bgz.
This repository contains scripts to download UK Biobank summary statistics from [Neale Lab](https://www.nealelab.is/uk-biobank/), filter significant variants, fine map risk loci and map candidate genes. The workflow retrieves required data, performs fine mapping with SusieR and annotates variants with GTEx, Activity-By-Contact (ABC) predictions and RegulomeDB scores.

It is sufficient to put the three files of the repository in a folder and run UKBB_main.R in RStudio to download and build the required database. Also, it is necessary to put in the same folder the RegulomeDB scores, available here: https://www.regulomedb.org/regulome-search/
## Required R packages

The analysis scripts depend on the following R packages: 

- `httr`
- `R.utils`
- `data.table`
- `gtexr`
- `otargen`
- `reticulate`
- `Matrix`
- `LDlinkR`
- `susieR`
- `yaml`
- `curl`

Ensure these packages are installed before running the pipeline. The workflow was
tested with **R 4.4.1** and **Python 3.12**.

## Python dependencies

The fine-mapping step relies on a Python environment with `numpy` and `scipy` available. The field `python.path` in `UKBB_config.yml` should contain the path to the Python interpreter that provides these packages. For example:

```yaml
python:
  path: "/usr/bin/python3"
```

## Configuring `UKBB_config.yml`

- **API keys**: request tokens from [OpenGWAS](https://gwas.mrcieu.ac.uk/) and
  [LDlink](https://ldlink.nci.nih.gov/?tab=apiaccess) and place them in the
  `api_keys` section.
- **phenotypes**: list the phenotype IDs (e.g. `20002_1482`) you want to analyse.
- **locus radius**: set `locus -> Radius` to the window size around each lead SNP (in bases).

Example configuration:

```yaml
python:
  path: "/usr/bin/python3"
api_keys:
  OpenGWAS: "YOUR_OPENGWAS_TOKEN"
  LDlinkR: "YOUR_LDLINKR_TOKEN"
filters:
  p_value_common: 5e-08
  p_value_uncommon: 1e-08
  hwe_p_value: 1e-06
  maf_common: 0.05
  maf_uncommon: 0.01
  pip_cutoff: 0.1
  abc_score_cutoff: 0.015
GTEx:
  version: "gtex_v10"
phenotypes:
  - "20002_1482"
  - "R53"
locus:
  Radius: 500000
```

Meaning of the parameters:

- `p_value_common` - cut-off for statistical significance for common variants in marginal regression.
- `p_value_uncommon` - cut-off for statistical significance for uncommon variants in marginal regression.
- `hwe_p_value` - cut-off for rejection of the hypothesis of Hardy-Weinberg equilibrium.
- `maf_common` - variants with minor allele frequency (MAF) above this value are regarded as common.
- `maf_uncommon` - variants with MAF above this value and below `maf_common` are regarded as uncommon; variants with MAF below `maf_uncommon` are discarded.
- `pip_cutoff` - variants with a posterior inclusion probability (PIP) below this value  are removed from the gene-mapping analysis.
- `abc_score_cutoff` - variants with an ABC score below this threshold are not considered to have a regulatory function.
- `GTEx -> version`: either `gtex_v8` or `gtex_v10` for eQTL detection.
- `locus -> Radius`: radius of loci, around their respective lead SNP. This affects the size of the LD matrices used for fine-mapping.

## Directory structure

Running `UKBB_main.R` creates the following directories if they do not already exist.
A complete run of the example configuration (two phenotypes) requires roughly
**12&nbsp;GB** of free disk space for downloaded data and intermediate files:

- `Data/NealeLab/` – UK Biobank summary statistics downloaded from [Neale Lab](https://broad-ukb-sumstats-us-east-1.s3.amazonaws.com/round2/additive-tsvs/).
- `Data/LD/` – LD matrices downloaded from the UK Biobank LD server.
- `Data/` – contains `ABC.tsv.bgz` with Activity-By-Contact predictions from the [Nasser et al. dataset](https://mitra.stanford.edu/engreitz/oak/public/Nasser2021/).
- `Data/ENCFF250UJY.tsv.gz` – RegulomeDB scores from [RegulomeDB](https://www.regulomedb.org/regulome-search/).
- `UKBB_output/` – final fine-mapped results and locus plots.

Place the downloaded RegulomeDB file (`ENCFF250UJY.tsv`) inside the main folder before running the analysis.

## Running the pipeline

The main script can be executed from RStudio or the command line:

```bash
Rscript UKBB_main.R
```

Alternatively, open `UKBB_main.R` in RStudio and run the script. The script will:

1. Download phenotype data and summary statistics for the selected phenotypes.
2. Retrieve ABC predictions and load RegulomeDB scores.
3. Identify lead variants, build LD matrices and run SusieR fine mapping.
4. Save per-phenotype results in `UKBB_output/` as `PHENO_SEX_finemapped.csv` and generate locus plots (`PHENO_SEX_RL.png`).
5. Append mapped genes to `My_genes_UKBB.csv` in the working directory.

The script produces intermediate data in `Data/` and final outputs in `UKBB_output/`.

## Data sources

- Neale Lab summary statistics: <https://www.nealelab.is/uk-biobank/>
- UK Biobank LD matrices: <https://broad-alkesgroup-ukbb-ld.s3.amazonaws.com/UKBB_LD/>
- ABC predictions: <https://mitra.stanford.edu/engreitz/oak/public/Nasser2021/AllPredictions.AvgHiC.ABC0.015.minus150.ForABCPaperV3.txt.gz>
- RegulomeDB scores: <https://www.regulomedb.org/regulome-search/>
  
## Output 1: fine-mapping

The following images represent the output of fine-mapping on the phenotypes 20002_1482 (self-reported Chronic Fatigue Syndrome) and ICD-10: R53 (Chronic Fatigue). Posterior Inclusion Probability (PIP) is reported on the y axis, and it represents the probability of being a causal variant. Credible sets are defined as sets of variants whose PIPs sum up to 95%. The legend indicates the number of credible sets, the size of each credible set, and the mean linkage disequilibrium (measured as |R|) between each possible pair of variants from the same credible set.

<img width="1000" height="500" alt="20002_1482_both_sexes_1" src="https://github.com/user-attachments/assets/c36f68e6-235a-423f-ac9a-db080ff2814a" />
<img width="1000" height="500" alt="20002_1482_female_1" src="https://github.com/user-attachments/assets/0133f4ed-e2b9-4e4e-8588-e4e64f1dc107" />
<img width="1000" height="500" alt="R53_female_1" src="https://github.com/user-attachments/assets/4f2b7650-e0d2-4ca8-bf71-a7e12910f8d9" />
<img width="1000" height="500" alt="R53_male_1" src="https://github.com/user-attachments/assets/917d4ab9-cfe1-49ed-978b-a8e579cdc2c2" />

## Output 2: gene-mapping

The genes associated with the phenotypes, and several details on the associations, are collected in the file My_genes_UKBB.csv, included in this repository. Some columns of the file are reported below.

| name     |   NCBI.id | Phenotype   | Sex        | Description   | Tissues (GTEx + ABC)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|:---------|----------:|:------------|:-----------|:--------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| SLC25A15 |     10166 | 20002_1482  | female     | eQTL          | Adipose_Subcutaneous/Brain_Hypothalamus/Brain_Nucleus_accumbens_basal_ganglia/Artery_Aorta/Esophagus_Muscularis/Cells_EBV-transformed_lymphocytes/Heart_Left_Ventricle/Brain_Substantia_nigra/Artery_Tibial/Brain_Putamen_basal_ganglia/Uterus/Brain_Frontal_Cortex_BA9/Esophagus_Gastroesophageal_Junction/Adipose_Visceral_Omentum/Brain_Caudate_basal_ganglia/Nerve_Tibial/Colon_Transverse/Brain_Hippocampus/Spleen/Adrenal_Gland/Heart_Atrial_Appendage/Artery_Coronary/Skin_Sun_Exposed_Lower_leg/Esophagus_Mucosa/Stomach/Brain_Spinal_cord_cervical_c-1/Colon_Sigmoid/Brain_Amygdala/Breast_Mammary_Tissue/Cells_Cultured_fibroblasts/Lung/Brain_Anterior_cingulate_cortex_BA24 |
| WBP4     |     11193 | 20002_1482  | female     | eQTL          | Muscle_Skeletal                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| MKI67    |      4288 | 20002_1482  | both_sexes | ABC           | bipolar_neuron_from_iPSC-ENCODE/MM.1S-ENCODE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| CLRN3    |    119467 | 20002_1482  | both_sexes | ABC           | MM.1S-ENCODE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| CCT6A    |       908 | R53         | female     | eQTL          | Nerve_Tibial                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| CHCHD2   |     51142 | R53         | female     | eQTL          | Brain_Nucleus_accumbens_basal_ganglia/Whole_Blood/Brain_Caudate_basal_ganglia/Brain_Cerebellar_Hemisphere                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| NUPR2    |    389493 | R53         | female     | eQTL          | Thyroid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ATP8B1   |      5205 | R53         | male       | eQTL          | Skin_Sun_Exposed_Lower_leg                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
